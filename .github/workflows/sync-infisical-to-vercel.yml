name: Sync EmailJS Env (Infisical ‚Üí Vercel)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  sync-env:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install Infisical + Vercel CLI
      - name: Install CLIs
        run: |
          npm install -g @infisical/cli@0.33.0 vercel

      # 4Ô∏è‚É£ Export env from Infisical ‚Üí .env
      - name: Export env from Infisical
        run: |
          infisical export \
            --projectId "$INFISICAL_PROJECT_ID" \
            --env "$INFISICAL_ENV" \
            --format dotenv > .env
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}

      # 5Ô∏è‚É£ Sync EmailJS envs to Vercel (Production only)
      - name: Sync EmailJS envs to Vercel
        run: |
          for key in \
            EMAILJS_PRIVATEKEY \
            EMAILJS_PUBLIC_KEY \
            EMAILJS_SERVICE_ID \
            EMAILJS_TEMPLATE_ID
          do
            value=$(grep "^$key=" .env | cut -d '=' -f 2-)

            if [ -z "$value" ]; then
              echo "‚ö†Ô∏è $key not found in Infisical"
              continue
            fi

            echo "üöÄ Syncing $key to Vercel (production)"
            echo "$value" | vercel env add "$key" production \
              --yes \
              --token="$VERCEL_TOKEN" \
              --scope="$VERCEL_ORG_ID" \
              --project="$VERCEL_PROJECT_ID"
          done
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
